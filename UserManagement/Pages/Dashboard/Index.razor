@page "/dashboard"
@using UserManagement.Helpers;
@using UserManagement.Services;
@using UserManagement.Shared.Models
@using UserManagement.Shared.Interface
@layout Shared.DashboardLayout
@inject IExternalAuthService AuthService
@inject ExternalAuthStateProvider AuthServiceStateProvider
@inject FileHelper fileHelper
@inject PDFHelper PDFHelper
@inject IJSRuntime JsRuntime
@inject ISnackbar Snackbar


<MudTable T="FileModel" Items="@allFiles" Filter="new Func<FileModel, bool>(FilterFunc)"
          SortLabel="Sort By">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Users</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="Year" InputType="InputType.Number" Placeholder="Year" Class="mt-0 mx-5"></MudTextField>
        <MudTextField @bind-Value="Month" InputType="InputType.Number" Placeholder="Month" Class="mt-0 mx-5"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>
            <MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<FileModel, object>(x => x.Name)">Name</MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<FileModel, object>(x => x.Year)">Year</MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortBy="new Func<FileModel, object>(x => x.Month)">Month</MudTableSortLabel>
        </MudTh>
        <MudTh></MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Year">@context.Year</MudTd>
        <MudTd DataLabel="Month">@context.Month</MudTd>
        <MudTd dir="ltr">
            <MudButton OnClick="@(() => ShowPdf(context))" Color="Color.Error">
                <MudIcon Icon="@Icons.Material.Filled.SimCardDownload" Color="Color.Error" />
            </MudButton>
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
    <EditButtonContent Context="button">
        <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" Disabled="@button.ButtonDisabled" />
    </EditButtonContent>
</MudTable>


@code {
    public int? Year;
    public int? Month;
    int EmployeeCode;
    List<FileModel> allFiles = new();

    protected override async Task OnInitializedAsync()
    {
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        var authState = await AuthServiceStateProvider.GetAuthenticationStateAsync();
        EmployeeCode = int.Parse(authState.User.Claims.FirstOrDefault(c => c.Type == "EmployeeCode").Value);
        allFiles = fileHelper.GetUserFiles(EmployeeCode);
        Console.WriteLine(allFiles.Count);
    }


    protected override void OnAfterRender(bool firstRender)
    {
        if(firstRender && allFiles.Count == 0)
        {
            Snackbar.Add("No files were found",Severity.Normal);
        }
    }


    private bool FilterFunc(FileModel element)
    {
        string year = Year?.ToString() ?? "";
        string month = Month?.ToString() ?? "";
        if (element.Year.ToString().Contains(year) &&
            element.Month.ToString().Contains(month)
        )
            return true;
        return false;
    }

    private async void ShowPdf(FileModel file)
    {
        PDFHelper.OpenNewTab(JsRuntime, $"{EmployeeCode}\\{file.Year}\\{file.Month}\\{file.Name}");
    }
}